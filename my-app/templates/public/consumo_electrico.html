{% extends 'public/base_cpanel.html' %}

{% block title %}Consumo ElÃ©ctrico{% endblock %}

{% block body %}
<div class="card content_consignaciones" style="border-radius: 0px !important">
  <section id="datosElectricos">

    <!-- âœ… SecciÃ³n de Consumo Actual -->
    <h3 class="text-center mt-4">ðŸ”Œ Consumo Actual</h3>
    <div class="text-center mb-4">
      <strong>Voltaje:</strong> <span id="voltaje_actual">Cargando...</span> V |
      <strong>Corriente:</strong> <span id="corriente_actual">Cargando...</span> A
    </div>

    <h2 class="text-center mt-4 mb-4">
      Registro de Consumo por Hora
      <hr />
    </h2>

    <div class="table-responsive text-nowrap">
      <table class="table table-hover" id="tablaDatosElectricos">
        <thead>
          <tr style="background-color: #ddd">
            <th>Fecha</th>
            <th>Hora</th>
            <th>Voltaje (V)</th>
            <th>Corriente (A)</th>
          </tr>
        </thead>
        <tbody>
          {% if datos_electricos %}
            {% for registro in datos_electricos %}
            <tr>
              <td>{{ registro.fecha }}</td>
              <td>{{ registro.hora }}</td>
              <td>{{ registro.voltaje }}</td>
              <td>{{ registro.corriente }}</td>
            </tr>
            {% endfor %}
          {% else %}
          <tr>
            <td colspan="4" class="text-center">No existen registros</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- âœ… PaginaciÃ³n mejorada -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mt-3">
        {% if page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=page-1) }}">Anterior</a>
        </li>
        {% endif %}

        {% set max_pages = 5 %}
        {% set start_page = (page - max_pages // 2) if (page - max_pages // 2) > 1 else 1 %}
        {% set end_page = (start_page + max_pages - 1) if (start_page + max_pages - 1) < total_paginas else total_paginas %}

        {% if end_page - start_page + 1 < max_pages %}
          {% set start_page = (end_page - max_pages + 1) if (end_page - max_pages + 1) > 1 else 1 %}
        {% endif %}

        {% if start_page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=1) }}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endif %}

        {% for num in range(start_page, end_page + 1) %}
        <li class="page-item {% if num == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=num) }}">{{ num }}</a>
        </li>
        {% endfor %}

        {% if end_page < total_paginas %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
        <li class="page-item">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=total_paginas) }}">{{ total_paginas }}</a>
        </li>
        {% endif %}

        {% if page < total_paginas %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=page+1) }}">Siguiente</a>
        </li>
        {% endif %}
      </ul>
    </nav>

  </section>
</div>

<!-- âœ… JavaScript para actualizar datos en tiempo real -->
<script>
  function actualizarConsumoActual() {
    fetch("{{ url_for('obtener_consumo_actual') }}")
      .then(response => response.json())
      .then(data => {
        document.getElementById("voltaje_actual").innerText = data.voltaje;
        document.getElementById("corriente_actual").innerText = data.corriente;
      })
      .catch(error => console.error("Error obteniendo consumo actual:", error));
  }

  // Actualizar cada 5 segundos
  setInterval(actualizarConsumoActual, 5000);
  actualizarConsumoActual();
</script>

{% endblock %}
