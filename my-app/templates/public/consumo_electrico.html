{% extends 'public/base_cpanel.html' %}

{% block title %}Consumo Eléctrico{% endblock %}

{% block body %}
<div class="card content_consignaciones" style="border-radius: 0px !important">
  <section id="datosElectricos">
    <h2 class="text-center mt-5 mb-5">
      Registro de Consumo Eléctrico
      <hr />
    </h2>

    <!-- Sección para mostrar el consumo actual en tiempo real -->
    <div class="text-center mb-4">
      <h4>Consumo Actual</h4>
      <p>Voltaje: <span id="voltaje_actual">--</span> V | Corriente: <span id="corriente_actual">--</span> A</p>
    </div>

    <div class="table-responsive text-nowrap">
      <h3 class="text-center mb-3">Registro de Consumo por Hora</h3> <!-- Nombre de la tabla cambiado -->
      <table class="table table-hover" id="tablaDatosElectricos">
        <thead>
          <tr style="background-color: #ddd">
            <th>Fecha</th>
            <th>Hora</th>
            <th>Voltaje (V)</th>
            <th>Corriente (A)</th>
          </tr>
        </thead>
        <tbody>
          {% if datos_electricos %}
            {% for registro in datos_electricos %}
            <tr>
              <td>{{ registro.fecha }}</td>
              <td>{{ registro.hora }}</td>
              <td>{{ registro.voltaje }}</td>
              <td>{{ registro.corriente }}</td>
            </tr>
            {% endfor %}
          {% else %}
          <tr>
            <td colspan="4" class="text-center">No existen registros</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mt-3">
        {% if page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=page-1) }}">Anterior</a>
        </li>
        {% endif %}

        {% set max_pages = 5 %}
        {% set start_page = page - max_pages // 2 %}
        {% set end_page = page + max_pages // 2 %}
        
        {% if start_page < 1 %}
          {% set start_page = 1 %}
          {% set end_page = max_pages %}
        {% endif %}
        
        {% if end_page > total_paginas %}
          {% set end_page = total_paginas %}
          {% set start_page = total_paginas - max_pages + 1 %}
        {% endif %}

        {% if start_page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=1) }}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endif %}

        {% for num in range(start_page, end_page + 1) %}
        <li class="page-item {% if num == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=num) }}">{{ num }}</a>
        </li>
        {% endfor %}

        {% if end_page < total_paginas %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
        <li class="page-item">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=total_paginas) }}">{{ total_paginas }}</a>
        </li>
        {% endif %}

        {% if page < total_paginas %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('consumo_electrico', page=page+1) }}">Siguiente</a>
        </li>
        {% endif %}
      </ul>
    </nav>

  </section>
</div>

<script>
  function actualizarConsumoActual() {
    fetch("{{ url_for('consumo_actual') }}")
      .then(response => response.json())
      .then(data => {
        document.getElementById("voltaje_actual").textContent = data.voltaje || "--";
        document.getElementById("corriente_actual").textContent = data.corriente || "--";
      })
      .catch(error => console.error("Error al obtener el consumo actual:", error));
  }

  // Actualiza cada 5 segundos
  setInterval(actualizarConsumoActual, 5000);
  actualizarConsumoActual();
</script>
{% endblock %}
